<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>俳句メロディーメーカー</title>
<style>
  body {
    font-family: "Yu Gothic", sans-serif;
    background: #f8f8f8;
    text-align: center;
    margin: 0;
  }
  header {
    background: #3aa14a;
    color: white;
    padding: 18px 0;
    font-size: 28px;
  }
  .info {
    margin: 20px auto;
    font-size: 20px;
    line-height: 1.8;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(19, 30px);
    grid-template-rows: repeat(6, 30px);
    gap: 4px;
    justify-content: center;
    margin: 20px auto;
  }
  .cell {
    width: 30px;
    height: 30px;
    border: 1px solid #ccc;
    background-color: white;
    font-size: 14px;
    color: #ccc;
    line-height: 30px;
  }
  .active {
    background-color: #4caf50;
    color: white;
  }
  button {
    margin: 20px;
    padding: 10px 20px;
    font-size: 18px;
    border: none;
    background: #4caf50;
    color: white;
    border-radius: 8px;
    cursor: pointer;
  }
  button:hover {
    background: #43a047;
  }
</style>
</head>
<body>

<header>🎵 俳句メロディーメーカー 🎵</header>

<div class="info" id="haikuInfo">作品を読み込み中...</div>
<div class="grid" id="grid"></div>
<button id="playButton">▶ 再生</button>

<script>
// === 音設定 ===
const notes = ["D4", "E4", "G4", "A4", "C5", "D5"]; // 低→高
let gridData = [];
let tempo = 120;

// === JSONを読み込む ===
const urlParams = new URLSearchParams(window.location.search);
const dataFile = urlParams.get("data");

// GitHub Pagesで確実に動くように絶対URL化
const baseURL = "https://nagaasa.github.io/haikumelody6/";
if (dataFile) {
  fetch(baseURL + dataFile)
    .then(response => {
      if (!response.ok) throw new Error("ファイルを取得できませんでした: " + dataFile);
      return response.json();
    })
    .then(data => loadFromJSON(data))
    .catch(err => {
      document.getElementById("haikuInfo").textContent =
        "作品データの読み込みに失敗しました: " + err.message;
    });
} else {
  document.getElementById("haikuInfo").textContent = "データが指定されていません。";
}

// === JSONデータを反映 ===
function loadFromJSON(data) {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  gridData = data.grid;
  tempo = parseInt(data.tempo) || 120;

  // 俳句と作者を表示
  const info = document.getElementById("haikuInfo");
  info.innerHTML = `
    <strong>作品名：</strong>${data.title || "（無題）"}<br>
    <strong>作者：</strong>${data.name || "（不明）"}<br>
    <strong>俳句：</strong>${(data.haikuArray || []).join("")}
  `;

  // グリッド作成（低音を下にする）
  for (let r = 0; r < 6; r++) {
    for (let c = 0; c < gridData[0].length; c++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.textContent = ["レ", "ミ", "ソ", "ラ", "ド", "高レ"][5 - r]; // 音名
      if (gridData[5 - r][c] === 1) {
        cell.classList.add("active");
      }
      grid.appendChild(cell);
    }
  }
}

// === 再生機能 ===
document.getElementById("playButton").addEventListener("click", () => {
  if (!gridData.length) return;
  playMelody();
});

function playMelody() {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const secondsPerBeat = 60 / tempo;
  const now = audioCtx.currentTime;

  gridData.forEach((row, rowIndex) => {
    row.forEach((cell, colIndex) => {
      if (cell === 1) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const noteFreq = getFrequency(notes[rowIndex]);
        osc.frequency.value = noteFreq;
        gain.gain.setValueAtTime(0.2, now + colIndex * secondsPerBeat);
        gain.gain.exponentialRampToValueAtTime(0.001, now + (colIndex + 1) * secondsPerBeat);
        osc.start(now + colIndex * secondsPerBeat);
        osc.stop(now + (colIndex + 1) * secondsPerBeat);
      }
    });
  });
}

function getFrequency(note) {
  const noteFreqs = {
    "D4": 293.66,
    "E4": 329.63,
    "G4": 392.00,
    "A4": 440.00,
    "C5": 523.25,
    "D5": 587.33
  };
  return noteFreqs[note];
}
</script>

</body>
</html>
