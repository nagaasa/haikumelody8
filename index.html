<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>ä¿³å¥ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
<style>
  body {
    font-family: "Yu Gothic", sans-serif;
    background: #f8f8f8;
    text-align: center;
    margin: 0;
  }
  header {
    background: #3aa14a;
    color: white;
    padding: 18px 0;
    font-size: 28px;
  }
  .info {
    margin: 20px auto;
    font-size: 20px;
    line-height: 1.8;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(19, 30px);
    grid-template-rows: repeat(6, 30px);
    gap: 4px;
    justify-content: center;
    margin: 20px auto;
  }
  .cell {
    width: 30px;
    height: 30px;
    border: 1px solid #ccc;
    background-color: white;
    font-size: 14px;
    color: #ccc;
    line-height: 30px;
  }
  .active {
    background-color: #4caf50;
    color: white;
  }
  button {
    margin: 20px;
    padding: 10px 20px;
    font-size: 18px;
    border: none;
    background: #4caf50;
    color: white;
    border-radius: 8px;
    cursor: pointer;
  }
  button:hover {
    background: #43a047;
  }
</style>
</head>
<body>

<header>ğŸµ ä¿³å¥ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼ãƒ¡ãƒ¼ã‚«ãƒ¼ ğŸµ</header>

<div class="info" id="haikuInfo">ä½œå“ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
<div class="grid" id="grid"></div>
<button id="playButton">â–¶ å†ç”Ÿ</button>

<script>
// === éŸ³è¨­å®š ===
const notes = ["D4", "E4", "G4", "A4", "C5", "D5"]; // ä½â†’é«˜
let gridData = [];
let tempo = 120;

// === JSONã‚’èª­ã¿è¾¼ã‚€ ===
const urlParams = new URLSearchParams(window.location.search);
const dataFile = urlParams.get("data");

// GitHub Pagesã§ç¢ºå®Ÿã«å‹•ãã‚ˆã†ã«çµ¶å¯¾URLåŒ–
const baseURL = "https://nagaasa.github.io/haikumelody6/";
if (dataFile) {
  fetch(baseURL + dataFile)
    .then(response => {
      if (!response.ok) throw new Error("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: " + dataFile);
      return response.json();
    })
    .then(data => loadFromJSON(data))
    .catch(err => {
      document.getElementById("haikuInfo").textContent =
        "ä½œå“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message;
    });
} else {
  document.getElementById("haikuInfo").textContent = "ãƒ‡ãƒ¼ã‚¿ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
}

// === JSONãƒ‡ãƒ¼ã‚¿ã‚’åæ˜  ===
function loadFromJSON(data) {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  gridData = data.grid;
  tempo = parseInt(data.tempo) || 120;

  // ä¿³å¥ã¨ä½œè€…ã‚’è¡¨ç¤º
  const info = document.getElementById("haikuInfo");
  info.innerHTML = `
    <strong>ä½œå“åï¼š</strong>${data.title || "ï¼ˆç„¡é¡Œï¼‰"}<br>
    <strong>ä½œè€…ï¼š</strong>${data.name || "ï¼ˆä¸æ˜ï¼‰"}<br>
    <strong>ä¿³å¥ï¼š</strong>${(data.haikuArray || []).join("")}
  `;

  // ã‚°ãƒªãƒƒãƒ‰ä½œæˆï¼ˆä½éŸ³ã‚’ä¸‹ã«ã™ã‚‹ï¼‰
  for (let r = 0; r < 6; r++) {
    for (let c = 0; c < gridData[0].length; c++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.textContent = ["ãƒ¬", "ãƒŸ", "ã‚½", "ãƒ©", "ãƒ‰", "é«˜ãƒ¬"][5 - r]; // éŸ³å
      if (gridData[5 - r][c] === 1) {
        cell.classList.add("active");
      }
      grid.appendChild(cell);
    }
  }
}

// === å†ç”Ÿæ©Ÿèƒ½ ===
document.getElementById("playButton").addEventListener("click", () => {
  if (!gridData.length) return;
  playMelody();
});

function playMelody() {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const secondsPerBeat = 60 / tempo;
  const now = audioCtx.currentTime;

  gridData.forEach((row, rowIndex) => {
    row.forEach((cell, colIndex) => {
      if (cell === 1) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const noteFreq = getFrequency(notes[rowIndex]);
        osc.frequency.value = noteFreq;
        gain.gain.setValueAtTime(0.2, now + colIndex * secondsPerBeat);
        gain.gain.exponentialRampToValueAtTime(0.001, now + (colIndex + 1) * secondsPerBeat);
        osc.start(now + colIndex * secondsPerBeat);
        osc.stop(now + (colIndex + 1) * secondsPerBeat);
      }
    });
  });
}

function getFrequency(note) {
  const noteFreqs = {
    "D4": 293.66,
    "E4": 329.63,
    "G4": 392.00,
    "A4": 440.00,
    "C5": 523.25,
    "D5": 587.33
  };
  return noteFreqs[note];
}
</script>

</body>
</html>
